name: Deploy Discord Bots

on:
  workflow_run:
    workflows: ["Release Discord Bots"]
    types:
      - completed

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      genie-changed: ${{ steps.filter.outputs['genie-bot'] }}
      trivia-changed: ${{ steps.filter.outputs['triviabot'] }}
      opie-changed: ${{ steps.filter.outputs['opie-bot'] }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            genie-bot:
              - 'genie-bot/**'
            triviabot:
              - 'triviabot/**'
            opie-bot:
              - 'opie-bot/**'

  deploy:
    needs: filter
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - bot: genie-bot
            changed: ${{ needs.filter.outputs.genie-changed }}
          - bot: triviabot
            changed: ${{ needs.filter.outputs.trivia-changed }}
          - bot: opie-bot
            changed: ${{ needs.filter.outputs.opie-changed }}

    steps:
      - name: Skip if unchanged
        if: ${{ matrix.changed != 'true' }}
        run: echo "No changes detected in ${{ matrix.bot }}, skipping."

      - name: Checkout
        if: ${{ matrix.changed == 'true' }}
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: ${{ matrix.changed == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install pnpm
        if: ${{ matrix.changed == 'true' }}
        run: npm install -g pnpm

      - name: Install jq
        if: ${{ matrix.changed == 'true' }}
        run: sudo apt-get install -y jq

      - name: Download Artifact
        if: ${{ matrix.changed == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.bot }}-artifact
          path: ./artifact

      - name: Load SSH Key
        if: ${{ matrix.changed == 'true' }}
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.VPS_PRIVATE_KEY }}

      - name: Add VPS to known_hosts
        if: ${{ matrix.changed == 'true' }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_Host }} >> ~/.ssh/known_hosts

      - name: Deploy Artifact to VPS
        if: ${{ matrix.changed == 'true' }}
        run: |
          VERSION=$(jq -r .version ./artifact/package.json)

          echo "Deploying ${{ matrix.bot }} version $VERSION to VPS..."

          scp -r \
            ./artifact/dist \
            ./artifact/package.json \
            ./artifact/pnpm-lock.yaml \
            "${{ secrets.VPS_USER }}@${{ secrets.VPS_Host }}:/var/www/discord-bots/DiscordBots/${{ matrix.bot }}"

          ssh "${{ secrets.VPS_USER }}@${{ secrets.VPS_Host }}" \
            "bash -lc '
              cd /var/www/discord-bots/DiscordBots/${{ matrix.bot }}
              pnpm install --prod --frozen-lockfile --ignore-scripts

              pm2 delete ${{ matrix.bot }}-\$VERSION || true
              pm2 start ./dist/index.js --name ${{ matrix.bot }}-\$VERSION
            '"

      - name: Notify Discord of Deploy
        if: ${{ matrix.changed == 'true' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          VERSION=$(jq -r .version ./artifact/package.json)
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"-#  **Deployed** \\\`${{ matrix.bot }}\\\` v.**v$VERSION** to production.\"}" \
               $DISCORD_WEBHOOK_URL
