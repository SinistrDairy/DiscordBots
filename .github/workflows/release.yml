name: Release Discord Bots
permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "genie-bot/**"
      - "triviabot/**"
      - "opie-bot/**"

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - bot: genie-bot
            tagPrefix: Gv
            botName: genie
          - bot: triviabot
            tagPrefix: Tv
            botName: trivia
          - bot: opie-bot
            tagPrefix: Ov
            botName: opie

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: |
          cd ${{ matrix.bot }}
          pnpm install

      - name: Safe sync with remote
        run: |
          cd ${{ matrix.bot }}

          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          git stash || true
          git fetch origin
          git rebase origin/main || true

          # Delete tag if created before
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            TAG=$(git describe --tags --abbrev=0)
            git tag -d "$TAG" || true
          fi

          git stash pop || true

      - name: Run release-it
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ${{ matrix.bot }}
          pnpm exec release-it --ci --increment patch --tag-prefix=${{ matrix.tagPrefix }}
          echo "RELEASE_VERSION=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      - name: Post release to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RELEASE_VERSION: ${{ steps.release.outputs.RELEASE_VERSION }}
          BOT_NAME: ${{ matrix.botName }}
        run: |
          cd ${{ matrix.bot }}

          CHANGELOG=$(head -n 30 CHANGELOG.md)

          CONTENT=$(printf "# %s\n### Version: \`%s\`\n\n#### Features & Fixes\n\n%s" \
            "$BOT_NAME" "$RELEASE_VERSION" "$CHANGELOG")

          echo "Posting to Discord:"
          echo "$CONTENT"

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"$(echo "$CONTENT" | sed ':a;N;$!ba;s/\n/\\n/g')\"}"
